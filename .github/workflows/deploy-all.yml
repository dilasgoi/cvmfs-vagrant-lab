name: Deploy Complete Stack

on:
  workflow_dispatch:
    inputs:
      quarter:
        description: 'Software stack quarter (e.g., 2025.Q1)'
        required: false
        type: string
      compat_version:
        description: 'Compat layer version (e.g., 2024.2)'
        required: false
        default: 'current'
        type: string
      deploy_compat:
        description: 'Deploy compatibility layer'
        required: true
        type: boolean
        default: false
      deploy_software:
        description: 'Deploy software stack'
        required: true
        type: boolean
        default: true

jobs:
  deploy-compat-layer:
    if: inputs.deploy_compat
    uses: ./.github/workflows/deploy-compat.yml
    with:
      version: ${{ inputs.compat_version }}
      architectures: all
      make_current: true

  deploy-software-stack:
    needs: [deploy-compat-layer]
    if: always() && inputs.deploy_software && (needs.deploy-compat-layer.result == 'success' || needs.deploy-compat-layer.result == 'skipped')
    uses: ./.github/workflows/deploy-software.yml
    with:
      quarter: ${{ inputs.quarter }}
      compat_version: ${{ inputs.compat_version }}

  summary:
    needs: [deploy-compat-layer, deploy-software-stack]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Complete Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Compat layer status
          if [[ "${{ inputs.deploy_compat }}" == "true" ]]; then
            if [[ "${{ needs.deploy-compat-layer.result }}" == "success" ]]; then
              echo "### Compatibility Layer: SUCCESS" >> $GITHUB_STEP_SUMMARY
              echo "Version: ${{ inputs.compat_version }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "### Compatibility Layer: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Compatibility Layer: SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Software stack status
          if [[ "${{ inputs.deploy_software }}" == "true" ]]; then
            if [[ "${{ needs.deploy-software-stack.result }}" == "success" ]]; then
              echo "### Software Stack: SUCCESS" >> $GITHUB_STEP_SUMMARY
              echo "Quarter: ${{ inputs.quarter || 'Auto-detected' }}" >> $GITHUB_STEP_SUMMARY
              echo "Using compat: ${{ inputs.compat_version }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "### Software Stack: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Software Stack: SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi
