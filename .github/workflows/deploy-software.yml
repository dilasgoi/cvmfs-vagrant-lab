name: Deploy HPC Software Stack

on:
  push:
    branches: [dev]
    paths:
      - 'software-stack/**'
  workflow_dispatch:
    inputs:
      quarter:
        description: 'Target quarter (e.g., 2025.Q1)'
        required: false
        type: string

env:
  CVMFS_REPOSITORY: software.lab.local

jobs:
  deploy-software:
    runs-on: [self-hosted, linux, cvmfs-publisher, "${{ matrix.arch }}"]
    strategy:
      matrix:
        include:
          - arch: x86-64-v3
            cvmfs_arch: intel/haswell
            is_primary: true  # This publisher creates structure
          - arch: x86-64-v4
            cvmfs_arch: intel/skylake_avx512
            is_primary: false
      max-parallel: 1  # Sequential to avoid conflicts
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set Quarter
        id: set-quarter
        run: |
          if [[ -n "${{ inputs.quarter }}" ]]; then
            QUARTER="${{ inputs.quarter }}"
          else
            QUARTER=$(date +"%Y.Q$(( ($(date +%-m)-1)/3+1 ))")
          fi
          echo "Quarter: $QUARTER"
          echo "QUARTER=$QUARTER" >> $GITHUB_ENV
      
      - name: Deploy to CVMFS
        run: |
          set +e  # Don't exit on error immediately
          
          CVMFS_ARCH="${{ matrix.cvmfs_arch }}"
          IS_PRIMARY="${{ matrix.is_primary }}"
          STACK_BASE="/cvmfs/$CVMFS_REPOSITORY/versions/$QUARTER/software/linux/x86_64"
          
          echo "🚀 Publisher: $(hostname)"
          echo "📅 Quarter: $QUARTER"
          echo "🏗️ Architecture: $CVMFS_ARCH"
          
          # Start transaction
          echo "Starting CVMFS transaction..."
          sudo -u vagrant cvmfs_server abort -f $CVMFS_REPOSITORY 2>/dev/null || true
          
          if ! sudo -u vagrant cvmfs_server transaction $CVMFS_REPOSITORY; then
            echo "❌ Failed to start transaction"
            exit 1
          fi
          
          # If primary publisher, create the full directory structure
          if [[ "$IS_PRIMARY" == "true" ]]; then
            echo "📁 Creating directory structure..."
            
            # Ensure base versions directory exists
            sudo mkdir -p "/cvmfs/$CVMFS_REPOSITORY/versions"
            
            # Check if structure already exists
            if [[ ! -f "/cvmfs/$CVMFS_REPOSITORY/versions/$QUARTER/.deployed" ]]; then
              # Create quarter directory
              sudo mkdir -p "/cvmfs/$CVMFS_REPOSITORY/versions/$QUARTER"
              
              # Create all architecture directories
              for arch_path in generic intel/haswell intel/skylake_avx512 intel/icelake amd/zen2 amd/zen3; do
                echo "  Creating $arch_path..."
                sudo mkdir -p "$STACK_BASE/$arch_path/software"
                sudo mkdir -p "$STACK_BASE/$arch_path/modules/all"
                
                # Create architecture info file
                echo "Architecture: $arch_path" | sudo tee "$STACK_BASE/$arch_path/ARCHITECTURE" > /dev/null
                echo "Created: $(date)" | sudo tee -a "$STACK_BASE/$arch_path/ARCHITECTURE" > /dev/null
                echo "Quarter: $QUARTER" | sudo tee -a "$STACK_BASE/$arch_path/ARCHITECTURE" > /dev/null
              done
              
              # Create current symlink
              sudo rm -f "/cvmfs/$CVMFS_REPOSITORY/versions/current"
              sudo ln -s "$QUARTER" "/cvmfs/$CVMFS_REPOSITORY/versions/current"
              
              # Create deployment marker
              echo "$(date)" | sudo tee "/cvmfs/$CVMFS_REPOSITORY/versions/$QUARTER/.deployed" > /dev/null
              
              echo "✅ Directory structure created"
            else
              echo "✓ Structure already exists"
            fi
          fi
          
          # Deploy software for this architecture
          echo "📦 Deploying software to $CVMFS_ARCH..."
          STACK_PATH="$STACK_BASE/$CVMFS_ARCH"
          
          # Process EasyBuild configs
          EB_COUNT=0
          FAILED=0
          
          for eb in software-stack/easyconfigs/*.eb; do
            if [[ -f "$eb" ]]; then
              echo "  Processing $(basename $eb)..."
              
              # Extract software info
              EB_NAME=$(basename "$eb" .eb)
              SOFTWARE=$(echo "$EB_NAME" | cut -d- -f1)
              VERSION=$(echo "$EB_NAME" | cut -d- -f2)
              TOOLCHAIN=$(echo "$EB_NAME" | cut -d- -f3,4 || echo "system")
              
              echo "    Software: $SOFTWARE"
              echo "    Version: $VERSION"
              echo "    Toolchain: $TOOLCHAIN"
              
              # Create installation directory
              INSTALL_DIR="$STACK_PATH/software/$SOFTWARE/$VERSION-$TOOLCHAIN"
              echo "    Creating directory: $INSTALL_DIR/bin"
              
              if ! sudo mkdir -p "$INSTALL_DIR/bin"; then
                echo "    ✗ Failed to create directory"
                FAILED=1
                continue
              fi
              
              echo "    ✓ Directory created"
              
              # Create mock binary
              BINARY_FILE="$INSTALL_DIR/bin/$SOFTWARE"
              echo "    Creating binary: $BINARY_FILE"
              
              # Create binary content in a temporary file first
              TEMP_BINARY="/tmp/${SOFTWARE}_binary_$$"
              cat > "$TEMP_BINARY" << EOFBINARY
#!/bin/bash
echo "$SOFTWARE version $VERSION"
echo "Architecture: $CVMFS_ARCH ($(hostname))"
echo "Toolchain: $TOOLCHAIN"
echo "Quarter: $QUARTER"
EOFBINARY
              
              # Copy to CVMFS
              if ! sudo cp "$TEMP_BINARY" "$BINARY_FILE"; then
                echo "    ✗ Failed to create binary"
                rm -f "$TEMP_BINARY"
                FAILED=1
                continue
              fi
              
              rm -f "$TEMP_BINARY"
              sudo chmod +x "$BINARY_FILE"
              echo "    ✓ Binary created"
              
              # Create module file
              MODULE_DIR="$STACK_PATH/modules/all/$SOFTWARE"
              if ! sudo mkdir -p "$MODULE_DIR"; then
                echo "    ✗ Failed to create module directory"
                FAILED=1
                continue
              fi
              
              MODULE_FILE="$MODULE_DIR/$VERSION-$TOOLCHAIN.lua"
              echo "    Creating module: $MODULE_FILE"
              
              # Create module in temporary file
              TEMP_MODULE="/tmp/${SOFTWARE}_module_$$"
              cat > "$TEMP_MODULE" << EOFMODULE
-- -*- lua -*-
help([[$SOFTWARE version $VERSION]])
whatis("Name: $SOFTWARE")
whatis("Version: $VERSION")
whatis("Architecture: $CVMFS_ARCH")

local root = "$INSTALL_DIR"
prepend_path("PATH", pathJoin(root, "bin"))
setenv("${SOFTWARE^^}_ROOT", root)
EOFMODULE
              
              # Copy to CVMFS
              if ! sudo cp "$TEMP_MODULE" "$MODULE_FILE"; then
                echo "    ✗ Failed to create module"
                rm -f "$TEMP_MODULE"
                FAILED=1
                continue
              fi
              
              rm -f "$TEMP_MODULE"
              echo "    ✓ Module created"
              
              ((EB_COUNT++))
              echo "  ✅ Successfully deployed $SOFTWARE"
            fi
          done
          
          echo
          echo "Summary: Deployed $EB_COUNT packages to $CVMFS_ARCH"
          
          if [[ $FAILED -ne 0 ]]; then
            echo "⚠️  Some deployments failed, but continuing..."
          fi
          
          # Publish transaction
          echo
          echo "Publishing changes..."
          if sudo -u vagrant cvmfs_server publish $CVMFS_REPOSITORY; then
            echo "✅ Successfully published!"
            exit 0
          else
            echo "❌ Publish failed"
            sudo -u vagrant cvmfs_server abort -f $CVMFS_REPOSITORY
            exit 1
          fi

  summary:
    needs: deploy-software
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## 📦 HPC Software Stack Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-software.result }}" == "success" ]]; then
            echo "### ✅ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The software stack has been deployed with:" >> $GITHUB_STEP_SUMMARY
            echo "- Directory structure for all architectures" >> $GITHUB_STEP_SUMMARY
            echo "- Software packages from EasyBuild configs" >> $GITHUB_STEP_SUMMARY
            echo "- Module files for each package" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          fi
